<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—æµ·é“7æ—¥é–“å‘¨éŠï¼ˆå…±æœ‰ç‰ˆï¼‰</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

    <header>
        <h1>â„ï¸ åŒ—æµ·é“æ—…ã®ã—ãŠã‚Š â„ï¸</h1>
        <div class="header-controls">
            <button onclick="toggleEditMode()" id="editBtn" class="btn-edit">âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
        </div>
    </header>

    <nav class="sticky-nav">
        <div class="nav-scroller" id="dayTabs">
            </div>
    </nav>

    <main id="scheduleContainer">
        <p style="text-align:center; margin-top:50px; color:#666;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // â–¼â–¼â–¼ ã‚ãªãŸã®è¨­å®šæƒ…å ±ã‚’åŸ‹ã‚è¾¼ã¿æ¸ˆã¿ â–¼â–¼â–¼
        const firebaseConfig = {
            apiKey: "AIzaSyD38ppWWbKL2TelivqqpxiUcYd9PRW1RPo",
            authDomain: "hokkaido-trip-cacb9.firebaseapp.com",
            databaseURL: "https://hokkaido-trip-cacb9-default-rtdb.firebaseio.com",
            projectId: "hokkaido-trip-cacb9",
            storageBucket: "hokkaido-trip-cacb9.firebasestorage.app",
            messagingSenderId: "836754090370",
            appId: "1:836754090370:web:a5e8ece492a1e13f0d879b"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã¨ãƒ­ã‚¸ãƒƒã‚¯ ---

        const defaultData = [
            { day: 1, title: "æ–°åƒæ­³ãƒ»å‡½é¤¨", events: [{ time: "09:00", title: "æ–°åƒæ­³ç©ºæ¸¯ ç€", desc: "ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼æ‰‹ç¶šã" }] },
            { day: 2, title: "å‡½é¤¨ãƒ»ç™»åˆ¥", events: [] },
            { day: 3, title: "æœ­å¹Œãƒ»å°æ¨½", events: [] },
            { day: 4, title: "æ—­å·ãƒ»ç¾ç‘›", events: [] },
            { day: 5, title: "ç¶²èµ°ãƒ»æµæ°·", events: [] },
            { day: 6, title: "é“æ±ãƒ»é‡§è·¯", events: [] },
            { day: 7, title: "å¸¯åºƒãƒ»å¸°è·¯", events: [] }
        ];

        let appData = [];
        let isEditMode = false;
        let currentActiveDay = 1;

        const dataRef = ref(db, 'trip/hokkaido');

        onValue(dataRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                appData = data;
            } else {
                appData = defaultData;
                set(dataRef, defaultData);
            }
            // ãƒ‡ãƒ¼ã‚¿ã‚’æ­£è¦åŒ–ï¼ˆeventsãŒãªã„å ´åˆã«ç©ºé…åˆ—ã‚’å…¥ã‚Œã‚‹å‡¦ç†ï¼‰
            appData.forEach(day => {
                if (!day.events) day.events = [];
            });
            
            renderTabs();
            renderSchedule();
        });

        window.saveToCloud = function() {
            set(dataRef, appData).catch((error) => {
                alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error);
            });
        };

        // --- UIæ“ä½œé–¢æ•° ---

        window.switchDay = function(dayNum) {
            currentActiveDay = dayNum;
            renderTabs();
            renderSchedule();
        }

        window.toggleEditMode = function() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('editBtn');
            if (isEditMode) {
                btn.innerText = "ğŸ’¾ ä¿å­˜ã—ã¦å®Œäº†";
                btn.style.background = "#e91e63";
                btn.style.color = "white";
            } else {
                window.saveToCloud();
                btn.innerText = "âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰";
                btn.style.background = "white";
                btn.style.color = "#0076a8";
            }
            renderSchedule();
        }

        window.updateDayTitle = (day, val) => {
            appData.find(d => d.day === day).title = val;
        };
        window.updateEvent = (day, idx, field, val) => {
            const targetDay = appData.find(d => d.day === day);
            if(targetDay && targetDay.events && targetDay.events[idx]) {
                targetDay.events[idx][field] = val;
            }
        };
        window.addEvent = (day) => {
            const targetDay = appData.find(d => d.day === day);
            // ã“ã“ã§é…åˆ—ãŒãªã‘ã‚Œã°ä½œã‚‹ï¼ˆé˜²å¾¡ç­–ï¼‰
            if (!targetDay.events) targetDay.events = [];
            
            targetDay.events.push({time:"10:00", title:"", desc:""});
            renderSchedule();
        };
        window.deleteEvent = (day, idx) => {
            if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                const targetDay = appData.find(d => d.day === day);
                if(targetDay && targetDay.events) {
                    targetDay.events.splice(idx, 1);
                    renderSchedule();
                }
            }
        };

        // --- æç”»é–¢æ•° ---

        function renderTabs() {
            const container = document.getElementById('dayTabs');
            container.innerHTML = '';
            appData.forEach(dayData => {
                const btn = document.createElement('button');
                btn.className = `tab-btn ${dayData.day === currentActiveDay ? 'active' : ''}`;
                btn.innerText = `Day ${dayData.day}`;
                btn.onclick = () => window.switchDay(dayData.day);
                container.appendChild(btn);
            });
        }

        function renderSchedule() {
            const container = document.getElementById('scheduleContainer');
            container.innerHTML = '';
            
            appData.forEach(dayData => {
                const section = document.createElement('div');
                section.className = `day-section ${dayData.day === currentActiveDay ? 'active' : ''}`;
                
                // eventsãŒ undefined ã®å ´åˆã¯ç©ºé…åˆ—ã«ã™ã‚‹ï¼ˆè¶…é‡è¦ï¼‰
                const events = dayData.events || [];

                let headerHTML = isEditMode ? 
                    `<div class="day-title"><input type="text" class="edit-input" value="${dayData.title}" onchange="updateDayTitle(${dayData.day}, this.value)" style="font-weight:bold; font-size:1.2rem;"></div>` :
                    `<div class="day-title"><h2>${dayData.day}æ—¥ç›®ï¼š${dayData.title}</h2></div>`;

                let eventsHTML = `<div class="timeline">`;
                
                // äºˆå®šãŒç©ºã®ã¨ãã®è¡¨ç¤º
                if (events.length === 0 && !isEditMode) {
                    eventsHTML += `<p style="color:#999; padding:20px 0;">ã¾ã äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>å³ä¸Šã®ã€Œç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã€ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>`;
                }

                events.forEach((evt, idx) => {
                    if (isEditMode) {
                        eventsHTML += `
                        <div class="event">
                            <div class="detail" style="border:1px solid #0076a8; background:#f0f8ff;">
                                <div style="display:flex; gap:5px; margin-bottom:5px;">
                                    <input type="time" class="edit-input" value="${evt.time}" onchange="updateEvent(${dayData.day}, ${idx}, 'time', this.value)" style="width:30%;">
                                    <input type="text" class="edit-input" value="${evt.title}" onchange="updateEvent(${dayData.day}, ${idx}, 'title', this.value)" style="width:70%;" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
                                </div>
                                <textarea class="edit-input" onchange="updateEvent(${dayData.day}, ${idx}, 'desc', this.value)" placeholder="è©³ç´°ãƒ¡ãƒ¢...">${evt.desc}</textarea>
                                <button onclick="deleteEvent(${dayData.day}, ${idx})" style="color:red; background:none; border:none; margin-top:5px; cursor:pointer;">ğŸ—‘ å‰Šé™¤</button>
                            </div>
                        </div>`;
                    } else {
                        eventsHTML += `
                        <div class="event">
                            <span class="time">${evt.time}</span>
                            <div class="detail">
                                <h3 class="event-title">${evt.title}</h3>
                                <p class="event-desc">${evt.desc}</p>
                            </div>
                        </div>`;
                    }
                });

                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ã€äºˆå®šãŒç©ºã§ã‚‚ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                if (isEditMode) {
                    eventsHTML += `<button class="add-event-btn" onclick="addEvent(${dayData.day})">ï¼‹ äºˆå®šã‚’è¿½åŠ </button>`;
                }
                
                eventsHTML += `</div>`;
                section.innerHTML = headerHTML + eventsHTML;
                container.appendChild(section);
            });
        }
    </script>
</body>
</html>
